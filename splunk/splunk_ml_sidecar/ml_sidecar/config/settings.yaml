# =============================================================================
# ML SIDECAR — MASTER CONFIGURATION FILE
# =============================================================================
# This file defines:
#   - Model directory / name
#   - Splunk ingestion settings
#   - Modeling parameters
#   - Output destinations (Splunk KVStore)
#
# NOTES:
#   • Do NOT check real Splunk tokens into Git. Use environment variables instead.
#   • Time ranges follow Splunk syntax (e.g., -24h, -30d, now)
#   • All paths are relative to the ml_sidecar working directory
# =============================================================================


# -----------------------------------------------------------------------------
# GENERAL MODEL SETTINGS
# -----------------------------------------------------------------------------
general:
  # Directory where model .pkl and metadata .json will be stored
  model_dir: "./models"

  # Base name for KMeans model files
  model_name: "auth_kmeans_v1"

# -----------------------------------------------------------------------------
# INGESTION SETTINGS (SPLUNK REST API)
# -----------------------------------------------------------------------------
ingestion:
  # Query for fetching authentication logs
  query: 'index = ml_sidecar sourcetype = ml:sidecar:json'


  # Time window for Splunk data ingestion
  # Example -> earliest: "-24h"
  earliest: "-90d"
  latest: "now"

  # Splunk REST API access details
  splunk:
    # Example : "https://127.0.0.1:8089"
    base_url: "<base-url>"

    # IMPORTANT:
    #   For production use:
    #       auth_token: ${SPLUNK_TOKEN}
    #   Instead of storing the JWT directly inside the YAML.
    auth_token: <splunk bearer token for inputs>



# -----------------------------------------------------------------------------
# MODELING SETTINGS
# -----------------------------------------------------------------------------
modeling:
  algorithm: "kmeans"

  # Candidate K values used for silhouette-based selection
  k_candidates: [6, 8, 10, 12, 14]

  # Ensure reproducibility
  random_state: 42

  # Global drift threshold for model retraining (p-value)
  drift_threshold: 0.05
  outlier_percentile: 0.95

  # Decide final outlier flag based on mode  
  outlier_mode: "combined"   # Options -> "user" | "cluster" | "global" | "combined"

  # Threshold sources used when outlier_mode = combined
  combined_logic: "and" # Options -> "and" | "or"
  thresholds:
    enable_user: true
    enable_cluster: true
    enable_global: false
  
  # Decide exporting outlier events
  export_outlier_events: true

# -----------------------------------------------------------------------------
# OUTPUT SETTINGS
# -----------------------------------------------------------------------------
output:
  # Only exporting to KVStore in this configuration
  writers:
    - "splunk_kvstore"

  # Splunk KVStore export configuration
  splunk_kvstore:
    enabled: true

    # Example -> "https://127.0.0.1:8089"
    base_url: "<base-url>"

    # Again — recommend using environment variables in production. 
    # Note : This Splunk can be different from ingestion.splunk.auth_token
    auth_token: <splunk bearer token for inputs>

    # Splunk App Name that contains the KVStore collections
    app: "ml_sidecar_app"

    # The specific collection to write
    collection: "auth_clusters"